<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tecnibo - Fiche Technique Cloison</title>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='editor.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Editor Modal -->
  <div id="editorModal">
    <div class="editor-container">
      <div class="editor-instructions">
        <strong>üìù Instructions:</strong>
        <ul style="margin: 10px 0;">
          <li>Cliquez sur l'image pour ajouter une annotation</li>
          <li>Entrez un num√©ro quand demand√©</li>
          <li>C√¥t√© gauche = annotations gauche, C√¥t√© droit = annotations droite</li>
          <li>Cliquez sur un petit cercle pour le d√©placer</li>
          <li>Clic droit sur un grand cercle pour le supprimer</li>
          <li>Cliquez sur "Enregistrer" quand termin√©</li>
        </ul>
      </div>
      <div class="editor-toolbar">
        <button class="btn-save-editor btn btn-success" onclick="saveEditorAnnotations()">üíæ Enregistrer</button>
        <button class="btn-clear-editor btn btn-danger" onclick="clearAllAnnotations()">üóëÔ∏è Effacer tout</button>
        <span id="editorStatus" class="ms-3 fw-bold"></span>
        <button class="btn-close-editor btn btn-secondary" onclick="closeEditor()">‚úñ Fermer</button>
      </div>
      <canvas id="editorCanvas" width="700" height="900"></canvas>
    </div>
  </div>


  <!-- Translation Modal -->
<!-- Translation Modal avec TEXTAREA au lieu d'INPUT -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Traduire</h2>
      <button type="button" class="close-btn" id="closeBtn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="translation-row">
        <div class="language-label"><strong>French (BE) / Fran√ßais (BE)</strong></div>
        <textarea class="translation-textarea" id="trans_fr" placeholder="Traduction fran√ßaise" rows="3"></textarea>
      </div>
      <div class="translation-row">
        <div class="language-label">Dutch (BE) / Nederlands (BE)</div>
        <textarea class="translation-textarea" id="trans_nl" placeholder="Nederlandse vertaling" rows="3"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="ignoreBtn">Ignorer</button>
      <button type="button" class="btn btn-primary" id="saveBtn">Enregistrer</button>
    </div>
  </div>
</div>


  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="container mt-4">

    <!-- Type Selection -->
    <div class="type-switch-section">
      <div class="radio-container">
        <label class="radio-label">
          <input type="radio" name="type" value="Cloison" id="typeCloison"
                 {% if type_selected == 'Cloison' %}checked{% endif %}> Cloison
        </label>
        <label class="radio-label">
          <input type="radio" name="type" value="Porte" id="typePorte"
                 {% if type_selected == 'Porte' %}checked{% endif %}> Porte
        </label>
      </div>
    </div>

    <!-- Reference Selection and Actions -->
    <div class="row mb-3">
      <div class="col">
        <div class="input-group">
          <select id="updateRef" name="updateRef" class="form-select" form="mainForm">
            <option value="">S√©lectionner une CPID ({{ type_selected }})</option>
            {% for cpid in cpids %}
              <option value="{{ cpid }}">{{ cpid }}</option>
            {% endfor %}
          </select>
          <button type="submit" formaction="/update_fiche" form="mainForm" class="btn btn-warning">Mettre √† jour</button>
          <button type="button" class="btn btn-info" onclick="GOficheTechnique()">Voir fiche</button>
          <button type="button" class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
        </div>
      </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="mainForm">

      <input type="hidden" name="type" value="{{ type_selected }}">

      <!-- Hidden fields pour les traductions NL -->
      <input type="hidden" name="reference_nl" id="reference_nl">
      <input type="hidden" name="reference_menu_nl" id="reference_menu_nl">
      <input type="hidden" name="variant_nl" id="variant_nl">
      <input type="hidden" name="description_nl" id="description_nl">
      <input type="hidden" name="hauteur_nl" id="hauteur_nl">
      <input type="hidden" name="largeur_nl" id="largeur_nl">
      <input type="hidden" name="epaisseur_nl" id="epaisseur_nl">
      <input type="hidden" name="tolerance_hauteur_nl" id="tolerance_hauteur_nl">
      <input type="hidden" name="verre_nl" id="verre_nl">
      <input type="hidden" name="panneau_nl" id="panneau_nl">
      <input type="hidden" name="poids_porte_cloison_nl" id="poids_porte_cloison_nl">
      <input type="hidden" name="resistance_feu_nl" id="resistance_feu_nl">
      <input type="hidden" name="nbn_s_01_400_nl" id="nbn_s_01_400_nl">
      <input type="hidden" name="nbn_en_iso_717_1_nl" id="nbn_en_iso_717_1_nl">
      {% for i in range(1, 23) %}
      <input type="hidden" name="vue_eclatee_{{ i }}_nl" id="vue_eclatee_{{ i }}_nl">
      {% endfor %}
      {% for i in range(1, 7) %}
      <input type="hidden" name="dessin_technique_nom_{{ i }}_nl" id="dessin_technique_nom_{{ i }}_nl">
      {% endfor %}

      <h1>Ajouter Fiche Technique - Cloison</h1>

      <!-- GENERAL INFORMATION -->
      <div class="category">INFORMATIONS G√âN√âRALES</div>
      <div class="row mb-2">
        <div class="col">
          <label for="cpid" class="form-label">CPID</label>
          <input type="text" class="form-control" name="cpid" id="cpid" placeholder="CPID" required>
        </div>
        <div class="col">
          <label class="form-label">R√©f√©rence</label>
          <div class="input-group">
            <input type="text" class="form-control" name="reference" placeholder="R√©f√©rence">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="reference">FR/NL</button>
          </div>
        </div>
      </div>

      <div class="row mb-2">
        <div class="col">
          <label for="reference_menu" class="form-label">R√©f√©rence menu</label>
          <div class="input-group">
            <input type="text" class="form-control" name="reference_menu" id="reference_menu" placeholder="Reference Menu">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="reference_menu">FR/NL</button>
          </div>
        </div>
        <div class="col">
          <label class="form-label">variant</label>
          <div class="input-group">
            <input type="text" class="form-control" name="variant" placeholder="variant">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="variant">FR/NL</button>
          </div>
        </div>
      </div>

      <div class="row mb-2">
        <div class="col">
          <label class="form-label">Description</label>
          <div class="input-group">
            <textarea class="form-control" name="description" rows="4" maxlength="300" placeholder="Description (max 300 caract√®res)"></textarea>
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="description">FR/NL</button>
          </div>
        </div>
      </div>

      <!-- Product Photo -->
      <div class="category">PHOTO DU PRODUIT</div>
      <div class="row mb-2">
        <div class="col">
          <input type="file" class="form-control" name="photo_produit" accept="image/*" onchange="previewImage(this, 'photoPreview')">
          <input type="hidden" name="delete_photo_produit" id="delete_photo_produit" value="false">
          <div class="image-preview-container mt-2">
            <img id="photoPreview" class="preview preview-image d-none" src="">
            <button type="button" class="delete-image-btn" onclick="markImageForDeletion('photo_produit', 'photoPreview')">√ó</button>
          </div>
        </div>
      </div>

      <!-- DIMENSIONS -->
      <div class="category">DIMENSIONS DES √âL√âMENTS</div>
      <div class="row mb-2">
        <div class="col"><label class="form-label">Hauteur</label>
          <div class="input-group">
            <input type="text" class="form-control" name="hauteur" placeholder="Hauteur (mm)">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="hauteur">FR/NL</button>
          </div>
        </div>
        <div class="col"><label class="form-label">Largeur</label>
          <div class="input-group">
            <input type="text" class="form-control" name="largeur" placeholder="Largeur (mm)">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="largeur">FR/NL</button>
          </div>
        </div>
        <div class="col"><label class="form-label">√âpaisseur</label>
          <div class="input-group">
            <input type="text" class="form-control" name="epaisseur" placeholder="√âpaisseur (mm)">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="epaisseur">FR/NL</button>
          </div>
        </div>
        <div class="col"><label class="form-label">Tol√©rance en hauteur</label>
          <div class="input-group">
            <input type="text" class="form-control" name="tolerance_hauteur" placeholder="Tol√©rance Hauteur (mm)">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="tolerance_hauteur">FR/NL</button>
          </div>
        </div>
      </div>

      <!-- MASSES VOLUMIQUES -->
      <div class="category">MASSES VOLUMIQUES</div>
      <div class="row mb-2">
        <div class="col"><label class="form-label">Verre (kg/m¬≥)</label>
          <div class="input-group">
            <input type="text" class="form-control" name="verre" placeholder="Verre (kg/m¬≥)">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="verre">FR/NL</button>
          </div>
        </div>
        <div class="col"><label class="form-label">Panneau</label>
          <div class="input-group">
            <input type="text" class="form-control" name="panneau" placeholder="Panneau">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="panneau">FR/NL</button>
          </div>
        </div>
        <div class="col"><label class="form-label">Poids cloison</label>
          <div class="input-group">
            <input type="text" class="form-control" name="poids_porte_cloison" placeholder="Poids cloison">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="poids_porte_cloison">FR/NL</button>
          </div>
        </div>
      </div>

      <!-- FIRE RESISTANCE -->
      <div class="category">R√âSISTANCE AU FEU</div>
      <div class="row mb-2">
        <div class="col"><label class="form-label">R√©sistance au feu standard</label>
          <div class="input-group">
            <input type="text" class="form-control" name="resistance_feu" placeholder="R√©sistance au feu standard">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="resistance_feu">FR/NL</button>
          </div>
        </div>
      </div>

      <!-- ACOUSTIC PERFORMANCE -->
      <div class="category">PERFORMANCE ACOUSTIQUE</div>
      <div class="row mb-2">
        <div class="col"><label class="form-label">NBN S 01-400</label>
          <div class="input-group">
            <input type="text" class="form-control" name="nbn_s_01_400" placeholder="NBN S 01-400">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="nbn_s_01_400">FR/NL</button>
          </div>
        </div>
        <div class="col"><label class="form-label">NBN EN ISO 717-1 (RW)</label>
          <div class="input-group">
            <input type="text" class="form-control" name="nbn_en_iso_717_1" placeholder="NBN EN ISO 717-1 (RW)">
            <button type="button" class="btn btn-outline-primary o_field_translate" data-field="nbn_en_iso_717_1">FR/NL</button>
          </div>
        </div>
      </div>

      <!-- EXPLODED VIEW IMAGE -->
      <div class="category">VUE √âCLAT√âE PRODUIT</div>
      <div class="row mb-2">
        <div class="col">
          <div class="input-group w-100">
            <input type="file" class="form-control" name="vue_eclatee_image" id="imageUpload" accept="image/*" onchange="handleImageUpload(this)" style="width:70%;">
            <button type="button" class="btn btn-light w-30" id="btnEditImage">‚úèÔ∏è √âditer</button>
          </div>
          <input type="hidden" name="delete_vue_eclatee_image" id="delete_vue_eclatee_image" value="false">
          <div id="imgError" class="text-danger mt-1" style="display:none;">‚ö† Image doit √™tre exactement 700x900 pixels !</div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col text-center">
          <div class="image-preview-container">
            <img id="explodedPreview" class="preview d-none" src="" style="max-width:100%; max-height:400px;">
            <button type="button" class="delete-image-btn" onclick="markImageForDeletion('vue_eclatee_image', 'explodedPreview')">√ó</button>
          </div>
        </div>
      </div>

      <!-- Exploded View Components -->
      {% for row in [(1,12), (2,13), (3,14), (4,15), (5,16), (6,17), (7,18), (8,19), (9,20), (10,21), (11,22)] %}
        <div class="row mb-2">
          <div class="col">
            <div class="input-group">
              <span class="input-group-text">{{ row[0] }}</span>
              <input type="text" class="form-control" name="vue_eclatee_{{ row[0] }}" placeholder="Composant {{ row[0] }}">
              <button type="button" class="btn btn-outline-primary o_field_translate" data-field="vue_eclatee_{{ row[0] }}">FR/NL</button>
            </div>
          </div>
          <div class="col">
            <div class="input-group">
              <span class="input-group-text">{{ row[1] }}</span>
              <input type="text" class="form-control" name="vue_eclatee_{{ row[1] }}" placeholder="Composant {{ row[1] }}">
              <button type="button" class="btn btn-outline-primary o_field_translate" data-field="vue_eclatee_{{ row[1] }}">FR/NL</button>
            </div>
          </div>
        </div>
      {% endfor %}

      <!-- TECHNICAL DRAWINGS -->
      <div class="category">DESSINS TECHNIQUES PRODUIT HORIZONTALE</div>
      {% for i in range(1,6) %}
        <div class="row mb-3 align-items-center">
          <div class="col-md-4">
            <input type="file" class="form-control" id="dessinInput{{i}}" name="dessin_technique_{{i}}" accept="image/*" onchange="checkExactSize(this, 'dessinPreview{{i}}', 'errorMsg{{i}}', {{i}})">
            <input type="hidden" name="delete_dessin_technique_{{i}}" id="delete_dessin_technique_{{i}}" value="false">
            <small id="errorMsg{{i}}" class="text-danger d-none">‚ö† Image horizontale {{i}} doit √™tre exactement <b>400 √ó 300 px</b>.</small>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control mt-2" name="dessin_technique_nom_{{i}}" placeholder="Nom du dessin {{i}}">
              <button type="button" class="btn btn-outline-primary o_field_translate" data-field="dessin_technique_nom_{{i}}">FR/NL</button>
            </div>
          </div>
          <div class="col-md-4 text-center">
            <div class="image-preview-container">
              <img id="dessinPreview{{i}}" class="preview d-none" src="" style="max-height:100px;">
              <button type="button" class="delete-image-btn" onclick="markImageForDeletion('dessin_technique_{{i}}', 'dessinPreview{{i}}')">√ó</button>
            </div>
          </div>
        </div>
      {% endfor %}

      <div class="category">DESSINS TECHNIQUES PRODUIT VERTICALE</div>
      {% for i in range(6,7) %}
        <div class="row mb-3 align-items-center">
          <div class="col-md-4">
            <input type="file" class="form-control" id="dessinInput{{i}}" name="dessin_technique_{{i}}" accept="image/*" onchange="checkExactSize(this, 'dessinPreview{{i}}', 'errorMsg{{i}}', {{i}})">
            <input type="hidden" name="delete_dessin_technique_{{i}}" id="delete_dessin_technique_{{i}}" value="false">
            <small id="errorMsg{{i}}" class="text-danger d-none">‚ö† Image verticale doit √™tre exactement <b>300 √ó 940 px</b>.</small>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control mt-2" name="dessin_technique_nom_{{i}}" placeholder="Nom du dessin {{i}}">
              <button type="button" class="btn btn-outline-primary o_field_translate" data-field="dessin_technique_nom_{{i}}">FR/NL</button>
            </div>
          </div>
          <div class="col-md-4 text-center">
            <div class="image-preview-container">
              <img id="dessinPreview{{i}}" class="preview d-none" src="" style="max-height:100px;">
              <button type="button" class="delete-image-btn" onclick="markImageForDeletion('dessin_technique_{{i}}', 'dessinPreview{{i}}')">√ó</button>
            </div>
          </div>
        </div>
      {% endfor %}

      <input type="hidden" name="previous_ref" id="previous_ref">

      <!-- Submit Button -->
      <div class="row mb-3">
        <div class="col">
          <button type="submit" class="btn btn-primary w-100" formaction="/add_fiche">Ajouter la Fiche Technique</button>
        </div>
      </div>

    </form>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/home.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  console.log('DOM loaded - initializing translation modal');

  const modalOverlay = document.getElementById('modalOverlay');
  const closeBtn = document.getElementById('closeBtn');
  const ignoreBtn = document.getElementById('ignoreBtn');
  const saveBtn = document.getElementById('saveBtn');
  const modalTitle = document.getElementById('modalTitle');
  const inputFR = document.getElementById('trans_fr');
  const inputNL = document.getElementById('trans_nl');

  let currentField = null;
  let currentInput = null;
  let currentInputNL = null;

  // Open modal when FR/NL button is clicked
  document.querySelectorAll('.o_field_translate').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      currentField = this.dataset.field;
      console.log('Opening modal for field:', currentField);

      // Find FR input/textarea
      currentInput =
        document.querySelector(`[name="${currentField}"]`) ||
        document.getElementById(currentField);

      // Find NL hidden input
      currentInputNL = document.getElementById(currentField + '_nl');

      if (!currentInput) {
        console.error('Input not found for field:', currentField);
        return;
      }

      modalTitle.textContent = `Modifier : ${currentField}`;

      // Load FR value
      inputFR.value = currentInput.value || '';

      // Load NL value if exists
      inputNL.value = currentInputNL ? (currentInputNL.value || '') : '';

      modalOverlay.classList.add('active');
      console.log('Modal opened');
    });
  });

  // Save button - saves both FR and NL values
  saveBtn.addEventListener('click', function () {
    console.log('Save clicked');

    // Save FR value
    if (currentInput) {
      currentInput.value = inputFR.value;
      console.log('Saved FR value:', inputFR.value);
    }

    // Save NL value
    if (currentInputNL) {
      currentInputNL.value = inputNL.value;
      console.log('Saved NL value:', inputNL.value);
    }

    closeModal();
  });

  // Ignore button
  ignoreBtn.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);

  // Close on overlay click
  modalOverlay.addEventListener('click', function(e) {
    if (e.target === modalOverlay) {
      closeModal();
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
      closeModal();
    }
  });

  function closeModal() {
    console.log('Closing modal');
    modalOverlay.classList.remove('active');
    currentField = null;
    currentInput = null;
    currentInputNL = null;
    inputFR.value = '';
    inputNL.value = '';
  }
});
</script>


</body>
</html>